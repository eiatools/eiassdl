<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EIASS Viewer & Downloader</title>
  <!-- GSAP & FileSaver CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Noto Sans KR',sans-serif}
    body{display:flex;height:100vh;background:#f5f5f5;color:#333}
    #sidebar{width:220px;background:#222;display:flex;flex-direction:column;overflow:auto}
    #sidebar h1{color:#fff;font-size:1.2rem;font-weight:bold;padding:18px 20px}
    .menu-btn{width:100%;padding:14px 20px;border:none;background:#222;color:#ddd;text-align:left;font-size:.9rem;cursor:pointer;transition:.2s}
    .menu-btn:hover,.menu-btn.active{background:#444;color:#fff}
    #content{flex:1;position:relative;overflow:auto;background:#fff}
    #content.loading:before{content:'로딩 중...';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:1.1rem;color:#666;background:rgba(255,255,255,.6);z-index:10}
    /* ---------------- Download UI ---------------- */
    #downloadPane{display:flex;flex-direction:column;height:100%;padding:24px;gap:14px}
    #downloadPane .section{background:#fafafa;border:1px solid #ddd;border-radius:6px;padding:18px}
    #downloadPane input{padding:8px 10px;border:1px solid #ccc;border-radius:4px;font-size:.95rem}
    #downloadPane button{padding:8px 16px;border:none;border-radius:4px;background:#4a90e2;color:#fff;font-size:.9rem;cursor:pointer;transition:.2s}
    #downloadPane button:hover{background:#357abd}
    table{width:100%;border-collapse:collapse;font-size:.9rem}
    thead{background:#f0f0f0}
    th,td{border:1px solid #ddd;padding:6px;text-align:center}
    td.filename{text-align:left}
    tbody tr.selected{background:#4a90e2;color:#fff}
    .prog{height:10px;background:#e0e0e0;border-radius:5px;overflow:hidden}
    .bar{height:100%;width:0;background:#2ecc71}
  </style>
</head>
<body>
  <nav id="sidebar"><h1>EIASS</h1></nav>
  <main id="content"></main>
  <script>
    const EIASS="https://www.eiass.go.kr";
    const BASE_DOWNLOAD_URL=`${EIASS}/common/file/downloadPdfByFileSeq.do`;

    const MENU=[
      {title:'전체목록', url:`${EIASS}/biz/base/info/searchListNew.do?menu=biz&biz_gubn=`},
      {title:'전략환경영향평가', url:`${EIASS}/biz/base/info/perList.do?menu=biz&biz_gubn=S`},
      {title:'소규모 환경영향평가', url:`${EIASS}/biz/base/info/perList.do?menu=biz&biz_gubn=M`},
      {title:'환경영향평가', url:`${EIASS}/biz/base/info/eiaList.do?menu=biz&biz_gubn=E`},
      {title:'사후환경영향조사', url:`${EIASS}/biz/base/info/afterList.do?menu=biz&biz_gubn=A`},
      {title:'사전환경성검토', url:`${EIASS}/biz/base/info/perList.do?menu=biz&biz_gubn=P`},
      {title:'기후변화영향평가', url:`${EIASS}/biz/base/info/weatherList.do`},
      {title:'평가항목 결정내용 공람', url:`${EIASS}/partcptn/result/resultSperssList.do`},
      {title:'평가서 초안 공람', url:`${EIASS}/partcptn/choan/choanSperssList.do`},
      {title:'다운로드', url:null}
    ];

    const sidebar=document.getElementById('sidebar');
    const content=document.getElementById('content');

    MENU.forEach((m,i)=>{
      const btn=document.createElement('button');
      btn.className='menu-btn';
      btn.textContent=m.title;
      btn.onclick=()=>selectMenu(i);
      sidebar.appendChild(btn);
    });

    function clearActive(){document.querySelectorAll('.menu-btn').forEach(b=>b.classList.remove('active'));}

    async function selectMenu(idx){
      const m=MENU[idx];
      clearActive();sidebar.children[idx+1].classList.add('active');
      content.innerHTML='';
      if(!m.url){renderDownloadPane();return;}
      content.classList.add('loading');
      try{
        const res=await fetch(`/api/proxy?url=${encodeURIComponent(m.url)}`);
        const html=await res.text();
        const doc=new DOMParser().parseFromString(html,'text/html');
        let part=doc.querySelector('article')||doc.querySelector('#wrap')||doc.body;
        // 링크 수정
        part.querySelectorAll('a[href]').forEach(a=>{
          const href=a.getAttribute('href');
          if(!href||href.startsWith('javascript'))return;
          const abs=new URL(href,m.url).href;
          a.href='#';
          a.onclick=e=>{e.preventDefault();window.open(`/api/proxy?url=${encodeURIComponent(abs)}`,'_blank');};
        });
        content.appendChild(part);
      }catch(e){content.textContent='로드 실패: '+e.message;}
      finally{content.classList.remove('loading');}
    }

    // 초기 메뉴
    selectMenu(0);

    /* ---------------- DOWNLOAD TAB ---------------- */
    let list=[];
    const $=id=>document.getElementById(id);

    function renderDownloadPane(){
      content.innerHTML=`<section id="downloadPane"><div class="section"><h3 style="margin-bottom:12px;font-size:1rem">시퀀스 번호 입력</h3><div style="display:flex;gap:8px;margin-bottom:10px"><input id="seq" maxlength="7" placeholder="7자리 시퀀스" style="flex:1"><button id="add">추가</button></div><div style="display:flex;gap:8px;align-items:center"><input id="seqStart" maxlength="7" placeholder="시작" style="flex:1"><span>~</span><input id="seqEnd" maxlength="7" placeholder="끝" style="flex:1"><button id="addRange">범위 추가</button></div></div><div class="section" style="display:flex;gap:8px;align-items:center"><button id="delSel" style="background:#e74c3c">선택 삭제</button><button id="delAll" style="background:#e74c3c">전체 삭제</button><div style="flex:1"></div><button id="run" style="background:#2ecc71">다운로드 실행</button></div><div class="section" style="flex:1;overflow:auto"><table id="tbl"><thead><tr><th>순번</th><th>시퀀스</th><th>상태</th></tr></thead><tbody></tbody></table></div><div class="section"><div class="prog"><div class="bar" id="bar"></div></div><div id="stat" style="margin-top:4px;font-size:.85rem">진행률: 0/0 (0%)</div></div></section>`;
      $('#add').onclick=()=>{const s=$('seq').value.trim();if(valid(s)&&!list.some(o=>o.seq===s)){list.push({seq:s,status:'대기'});$('seq').value='';draw();}};
      $('#addRange').onclick=()=>{const s=$('seqStart').value.trim(),e=$('seqEnd').value.trim();if(valid(s)&&valid(e)&&+s<=+e){for(let n=+s;n<=+e;n++){const seq=String(n).padStart(7,'0');if(!list.some(o=>o.seq===seq))list.push({seq,status:'대기'});}draw();}else alert('범위 오류');};
      $('#delSel').onclick=()=>{const sel=[...document.querySelectorAll('#tbl tbody tr.selected')].map(r=>r.rowIndex-1);list=list.filter((_,i)=>!sel.includes(i));draw();};
      $('#delAll').onclick=()=>{list=[];draw();};
      $('#run').onclick=downloadAll;
      document.getElementById('tbl').onclick=e=>{if(e.target.tagName==='TD')e.target.parentNode.classList.toggle('selected');};
      draw();
    }
    const valid=s=>/^\d{7}$/.test(s);
    function draw(){const tbody=document.querySelector('#tbl tbody');tbody.innerHTML='';list.forEach((o,i)=>tbody.insertAdjacentHTML('beforeend',`<tr><td>${i+1}</td><td>${o.seq}</td><td id="st${o.seq}">${o.status}</td></tr>`));updateBar();}
    function updateBar(){const done=list.filter(o=>o.status==='완료').length,p=list.length?Math.round(done/list.length*100):0;$('#bar').style.width=p+'%';$('#stat').textContent=`진행률: ${done}/${list.length} (${p}%)`;}
    async function downloadAll(){for(const o of list){if(o.status!=='대기')continue;const td=$(`#st${o.seq}`);td.textContent='진행중';try{const url=`${BASE_DOWNLOAD_URL}?FILE_SEQ=${o.seq}`;const r=await fetch(`/
