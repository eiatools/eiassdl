<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EIASS Viewer & Downloader</title>
  <!-- GSAP & FileSaver CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Noto Sans KR',sans-serif}
    body{display:flex;height:100vh;background:#f5f5f5;color:#333}
    #sidebar{width:220px;background:#222;display:flex;flex-direction:column}
    #sidebar h1{color:#fff;font-size:1.2rem;font-weight:bold;padding:18px 20px}
    .menu-btn{width:100%;padding:14px 20px;border:none;background:#222;color:#ddd;text-align:left;font-size:.92rem;cursor:pointer;transition:.2s}
    .menu-btn:hover,.menu-btn.active{background:#444;color:#fff}
    #content{flex:1;position:relative;background:#fff;overflow:hidden}
    iframe{border:none;width:100%;height:100%}
    #downloadPane{display:flex;flex-direction:column;gap:16px;padding:40px;max-width:640px;margin:0 auto}
    #downloadPane input,#downloadPane textarea{padding:10px;width:100%;border:1px solid #ccc;border-radius:4px;font-size:1rem}
    #downloadPane button{padding:12px;border:none;border-radius:4px;background:#0095ff;color:#fff;font-size:1rem;cursor:pointer;transition:.2s}
    #downloadPane button:hover{background:#0077d9}
    #log{height:160px;overflow:auto;border:1px solid #ddd;border-radius:4px;padding:10px;font-size:.85rem;background:#fafafa}
    .prog{margin-top:6px;height:8px;background:#e0e0e0;border-radius:4px;overflow:hidden}
    .bar{height:100%;width:0;background:#4caf50}
  </style>
</head>
<body>
  <nav id="sidebar">
    <h1>EIASS</h1>
  </nav>
  <main id="content"></main>
  <script>
    const BASE_DOWNLOAD_URL = "https://www.eiass.go.kr/common/file/downloadPdfByFileSeq.do";

    // 메뉴 정의 (총 10개)
    const MENU = [
      {title:'전체목록', key:'all', url:'https://eiass.go.kr/biz/base/info/searchListNew.do?menu=biz&biz_gubn='},
      {title:'전략환경영향평가', key:'strategic', url:'https://eiass.go.kr/biz/base/info/perList.do?menu=biz&biz_gubn=S'},
      {title:'소규모 환경영향평가', key:'small', url:'https://www.eiass.go.kr/biz/base/info/perList.do?menu=biz&biz_gubn=M'},
      {title:'환경영향평가', key:'eia', url:'https://www.eiass.go.kr/biz/base/info/eiaList.do?menu=biz&biz_gubn=E'},
      {title:'사후환경영향조사', key:'after', url:'https://www.eiass.go.kr/biz/base/info/afterList.do?menu=biz&biz_gubn=A'},
      {title:'사전환경성검토', key:'pre', url:'https://www.eiass.go.kr/biz/base/info/perList.do?menu=biz&biz_gubn=P'},
      {title:'기후변화영향평가', key:'climate', url:'https://www.eiass.go.kr/biz/base/info/weatherList.do'},
      {title:'평가항목 결정내용 공람', key:'decision', url:'https://www.eiass.go.kr/partcptn/result/resultSperssList.do'},
      {title:'평가서 초안 공람', key:'draft', url:'https://www.eiass.go.kr/partcptn/choan/choanSperssList.do'},
      {title:'다운로드', key:'download', url:null}
    ];

    const sidebar = document.getElementById('sidebar');
    const content = document.getElementById('content');

    // 메뉴 버튼 렌더
    MENU.forEach((m,i)=>{
      const btn=document.createElement('button');
      btn.className='menu-btn';
      btn.textContent=m.title;
      btn.onclick=()=>selectMenu(i);
      sidebar.appendChild(btn);
    });

    function clearActive(){
      [...document.querySelectorAll('.menu-btn')].forEach(b=>b.classList.remove('active'));
    }

    function selectMenu(idx){
      const menu=MENU[idx];
      clearActive();
      sidebar.children[idx+1].classList.add('active'); // +1 offset for h1
      content.innerHTML='';
      if(menu.key==='download'){
        renderDownloadPane();
      }else if(menu.url){
        const frame=document.createElement('iframe');
        frame.src=`/api/proxy?url=${encodeURIComponent(menu.url)}`;
        content.appendChild(frame);
      }
      gsap.fromTo(content,{opacity:0},{opacity:1,duration:0.25});
    }

    // 첫 메뉴 기본 선택
    selectMenu(0);

    function renderDownloadPane(){
      const pane=document.createElement('section');
      pane.id='downloadPane';
      pane.innerHTML=`
        <label>시퀀스 번호 입력 (여러 개는 쉼표·공백·줄바꿈):</label>
        <textarea id="seqInput" rows="4" placeholder="예: 1234567, 2345678"></textarea>
        <button id="run">다운로드</button>
        <div class="prog"><div class="bar" id="progressBar"></div></div>
        <pre id="log"></pre>
      `;
      content.appendChild(pane);
      document.getElementById('run').onclick=runDownloadFlow;
    }

    async function runDownloadFlow(){
      const raw=document.getElementById('seqInput').value;
      const seqList=[...new Set(raw.split(/[^0-9]+/).filter(s=>s.length===7))];
      if(!seqList.length){alert('7자리 시퀀스 번호를 입력하세요');return;}
      log(`총 ${seqList.length}건 다운로드 시작`);
      const bar=document.getElementById('progressBar');
      let finished=0;
      const concurrency=3;
      let active=0;let idx=0;
      function next(){
        if(idx>=seqList.length){return;}
        while(active<concurrency&&idx<seqList.length){
          const seq=seqList[idx++];
          active++;
          downloadSeq(seq).finally(()=>{active--;finished++;bar.style.width=`${finished/seqList.length*100}%`;next();});
        }
        if(finished===seqList.length){log('다운로드 완료');}
      }
      next();
    }

    async function downloadSeq(seq){
      const url=`${BASE_DOWNLOAD_URL}?FILE_SEQ=${seq}`;
      try{
        const res=await fetch(`/api/proxy?url=${encodeURIComponent(url)}`);
        if(!res.ok){throw new Error(res.statusText);}        
        const cd=res.headers.get('content-disposition')||'';
        let filename=`${seq}.pdf`;
        const match=cd.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/i);
        if(match){filename=decodeURIComponent(match[1].replace(/['"]/g,''));}
        const blob=await res.blob();
        saveAs(blob,filename);
        log(`✅ ${seq} → ${filename}`);
      }catch(e){
        log(`❌ ${seq}: ${e.message}`);
      }
    }

    function log(msg){
      const el=document.getElementById('log');
      el.textContent+=`\n${new Date().toLocaleTimeString()} ${msg}`;
      el.scrollTop=el.scrollHeight;
    }
  </script>
</body>
</html>
